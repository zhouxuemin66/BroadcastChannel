---
import '../assets/item.css'
import 'prismjs/themes/prism.css'
import dayjs from '../lib/dayjs'
import { getEnv } from '../lib/env'

const locale = getEnv(import.meta.env, Astro, 'LOCALE')
const timezone = getEnv(import.meta.env, Astro, 'TIMEZONE')

locale && dayjs.locale(locale)

const { SITE_URL } = Astro.locals
const { post, isItem } = Astro.props

const channel = getEnv(import.meta.env, Astro, 'CHANNEL')
const COMMENTS = getEnv(import.meta.env, Astro, 'COMMENTS')

const datetime = dayjs(post.datetime).tz(timezone)
const timeago = datetime.isBefore(dayjs().subtract(1, 'w')) ? datetime.format('HH:mm Â· ll Â· ddd') : datetime.fromNow()

// æ¸…æ´— HTML å†…å®¹
function cleanContent(raw) {
  return raw
    // 1. ç§»é™¤ç½‘ç«™ç½‘å€æ®µï¼ˆå¯é€‰ï¼‰
    .replace(/ç½‘ç«™ç½‘å€ï¼š.*?<br\s*\/?>/gi, '')

    // 2. ç§»é™¤åŒ…å« æŠ•ç¨¿ / é¢‘é“ / èŠå¤© ç­‰ emoji é“¾æ¥çš„æ®µè½
    .replace(/(<i class="emoji">.*?<\/i>\s*<a .*?<\/a>\s*)+/gi, '')

    // 3. ç§»é™¤å°¾éƒ¨çš„ "via <a href=...>..."
    .replace(/via\s*<a[^>]*>[\s\S]*?<\/a>/gi, '')

    // æ–°å¢ï¼šç§»é™¤ ğŸ“¢ é¢‘é“ å’Œ ğŸ‘¥ ç¾¤ç»„ ç›¸å…³å†…å®¹
    .replace(/<br\s*\/?>?<i class="emoji"><b>ğŸ“¢<\/b><\/i>\s*é¢‘é“ï¼š<a[^>]*>.*?<\/a>/gi, '')
    .replace(/<br\s*\/?>?<i class="emoji"><b>ğŸ‘¥<\/b><\/i>\s*ç¾¤ç»„ï¼š<a[^>]*>.*?<\/a>/gi, '')

    // 4. å¤šä½™ç©ºè¡Œå¤„ç†ï¼ˆå¯é€‰ï¼‰
    .replace(/<br\s*\/?>\s*<br\s*\/?>/gi, '<br>')
}

const cleanedContent = cleanContent(post.content)
---

<div class="item" style={{ 'view-transition-name': `post-${post.id}` }}>
  <div class="time-box">
    <div class="dot"></div>
    <div class="time">
      <a href={`${SITE_URL}posts/${post.id}`} title={post.datetime} class="item-link">
        <time datetime={post.datetime} title={timeago}>{timeago}</time>
      </a>
    </div>
  </div>

  <div class="text-box content" set:html={cleanedContent} />

  {
    post.tags.length > 0 && (
      <div class="tag-box" style={post.content.length === 0 ? 'padding-top: 30px;' : ''}>
        <div class="tag-icon" />
        {post.tags.map((tag) => (
          <a href={`/search/%23${tag}`} title={tag} class="tag">
            {tag}
          </a>
        ))}
      </div>
    )
  }

  {
    COMMENTS && isItem && (
      <div class="comments">
        <script
          is:inline
          async
          src="https://telegram.org/js/telegram-widget.js"
          data-telegram-discussion={`${channel}/${post.id}`}
          data-comments-limit="50"
          data-colorful="1"
          data-color="454545"
        />
      </div>
    )
  }
</div>
